<html>
<head>
  <title>War of the Five Kings</title>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <style>
  /**
   * General styles
   */
  * {
    outline: none;
  }
  body {
    background-image: url("images/wallpaper.png");
  }
  .header { 
    height: 150px; 
    margin-bottom: 30px;
    font-family: "High Tower Text";
  }
  .section {
    float: left;
    height: 770px;
    margin: 5px;
  }
  #map {
    width: 400px;
  }
  .army {
    stroke: #000;
    stroke-width: 2px;
  }
  #timeline {
    padding-left: 20px;
    width: 200px;
    font-family: "High Tower Text";
  }
  .button {
   
    width: auto;
    border: none;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    cursor: pointer;
  }
  #side {
    width: 500px;
    font-family: "High Tower Text";
  }
  #banner-container {
    padding-top: 8px;
    width: 100px;
  }
  #banner-container div.banner-label {
    width: 95px;
    font-family: "High Tower Text";
    text-align: center;
    padding-bottom: 5px;
    cursor: pointer;
  }
  #banner-container img {
    width: 95px;
    height: 114px;
    margin-bottom: 15px;
    cursor: pointer;
  }
  img.hidden-family {
    opacity: 0.5;
  }

  #player {
    position: relative;
  }
  #player #time-select {
    position: absolute;
    top: 390;
    left: -375px;
    transform: rotate(90deg);
    height: 20px;
    width: 720px;
  }

  #spear_slider {
    position: absolute;
    top:-32;
    left: -40;
    max-height: 875px;
    max-width: auto; /* you can use % */
  }

  /**
   * Time selection slider
   */
  input[type=range] {
    background: transparent;
    -webkit-appearance: none;
  }
  input[type=range]::-webkit-slider-runnable-track {
    background: transparent;
    cursor: pointer;
  }
  input[type=range]::-webkit-slider-thumb {
    height: 29px;
    width: 30px;
    border-radius: 7px;
    background-image: url("images/slider.png");
    background-size: 30px 29px;
    background-repeat: no-repeat;
    cursor: pointer;
    -webkit-appearance: none;
  }
  input[type=range]::-moz-range-track {
    background: transparent;
    cursor: pointer;
  }
  input[type=range]::-moz-range-thumb {
    height: 29px;
    width: 30px;
    border-radius: 7px;
    background-image: url("images/slider.png");
    background-size: 30px 29px;
    background-repeat: no-repeat;
    cursor: pointer;
  }
  </style>
</head>
<body>
  <div class="header" id="logo">
    <svg id="banner" width="1200" height="150">
      <image xlink:href="images/Game_of_Thrones_logo.png" height="100" width="600" x="300" y="0" />
      <line stroke-width="2" stroke="black" x1="0" y1="10" x2="1200" y2="10" />

      <image xlink:href="images/stannis-emblem.png" height="110" width="100" x="0" y="10" />
        <text x="50" y="130" text-anchor="middle" font-size="13" fill="black"> House Baratheon</text>
        <text x="50" y="140" text-anchor="middle" font-size="13" fill="black"> (Stannis)</text>
      <image xlink:href="images/greyjoy-emblem.png" height="110" width="100" x="100" y="10" />
       <text x="150" y="130" text-anchor="middle" font-size="13" fill="black">House Greyjoy</text>
      <image xlink:href="images/lannister-emblem.png" height="110" width="100" x="200" y="10" />
        <text x="250" y="130" text-anchor="middle" font-size="13" fill="black">House Lannister</text>
      <image xlink:href="images/stark-emblem.png" height="110" width="100" x="900" y="10" />
        <text x="950" y="130" text-anchor="middle" font-size="13" fill="black">House Stark</text>
      <image xlink:href="images/renly-emblem.png" height="110" width="100" x="1000" y="10" />
        <text x="1050" y="130" text-anchor="middle" font-size="13" fill="black">House Baratheon</text>
        <text x="1050" y="140" text-anchor="middle" font-size="13" fill="black">(Renly)</text>
      <image xlink:href="images/mimno-emblem.png" height="110" width="100" x="1100" y="10" />
        <text x="1150" y="130" text-anchor="middle" font-size="13" fill="black">House Mimno(</text>

      <text x="600" y="120" text-anchor="middle" font-size="36" fill="black">War of the Five Kings</text>
    </svg>
  </div>
  <!-- <div class="section" id="banner-container">
    <div id="lannister-banner" class="banner">
      <div class="banner-label">Lannister</div>
      <img src="images/lannister-emblem.png"/>
    </div>
    <div id="greyjoy-banner" class="banner">
      <div class="banner-label">Greyjoy</div>
      <img src="images/greyjoy-emblem.png"/>
    </div>
    <div id="stannis-banner" class="banner">
      <div class="banner-label">Stannis</div>
      <img src="images/stannis-emblem.png"/>
    </div>
    <div id="stark-banner" class="banner">
      <div class="banner-label">Stark</div>
      <img src="images/stark-emblem.png"/>
    </div>
    <div id="renly-banner" class="banner">
      <div class="banner-label">Renly</div>
      <img src="images/renly-emblem.png"/>
    </div>
  </div> -->
  <div class="section" id="map"></div>
  <div class="section" id="timeline">
    <div id="player">
      <img class="button" id="play"  src="images/play1.png"  height= "36";/>
      <img class="button" id="pause" src="images/pause1.png"  height= "36";/>
      <img class="button" id="reset" src="images/reset1.png"  height="44";/>
      <img id="spear_slider" src="images/spear.png"/>
      <input type="range" id="time-select" min="0" max="20" step="1" value="0" />
      <span id="slider-value">0</span>
    </div>
  </div>
  <div class="section" id="side"></div>

  <script>
    var STEP_DURATION = 2000, // Duration of a single time step
        LAST_STEP;            // Max # of frames

    var IS_PLAYING = false,   // true if the animation is running
        next_step;            // holds the timeout

		var height = 770,
		    width  = 400;

    var current_step = 0;

    var army_scale = d3.scale.sqrt(),
        x_scale    = d3.scale.linear(),
        y_scale    = d3.scale.linear();

    var battle_data, route_data, location_mapper = {};
    var affiliation_mapper = {
      'Greyjoy':   '#a24f00',
      'Lannister': '#850c11',
      'Stark':     '#4b4e61',
      'Stannis':   '#ffff69',
      'Renly':     '#1e5e30'
    }

    var army_opacity = 0.7;
    var hidden_families = {
      'lannister': false,
      'greyjoy':   false,
      'stannis':   false,
      'stark':     false,
      'renly':     false
    }

    d3.selectAll('div.banner').on('click', function () {
      var family = this.id.split('-')[0];
      hidden_families[family] = !hidden_families[family];

      // Hide/show families of clicked family
      d3.selectAll('.army')
        .filter(function (a) {
          return d3.select(this).classed(family);
        })
        .style('opacity', hidden_families[family] ? '0' : army_opacity);

      // Toggle opacity of image
      var had_class = d3.select(this).select('img').classed('hidden-family');
      d3.select(this)
        .select('img')
        .classed('hidden-family', !had_class);
    });

    /****************************** Westeros Map ******************************/

    var svg = d3.select('#map')
        .append('svg')
        .attr('width', width)
        .attr('height', height);

    var defs = svg.append('defs');

    var g = svg.append('g');
    var zoom_behavior = d3.behavior.zoom()
      .scaleExtent([1, 4])
      .on('zoom', zoom_func);

    var swords = [];

    d3.xml('westeros_test.svg', 'image/svg+xml', function (err, xml) {
      if (err) throw err;
      var importedNode = document.importNode(xml.documentElement, true);

      g.call(zoom_behavior);
      g.node().appendChild(importedNode);

      // Create the battle icons
      d3.xml('swords.svg', 'image/svg+xml', function (err, xml) {
        if (err) throw err;
        var importedNode = document.importNode(xml.documentElement, true);

        defs
          .node()
          .appendChild(importedNode);
        defs.select('svg').attr('id', 'swords');

        for (var i = 0; i < 9; i++) {
          swords.push(g.append('g'));
          swords[i].append('g')
            .attr('transform', 'translate(20, 20) scale(0.05) rotate(180)')
            .append('use')
            .attr('xlink:href', '#swords');
          swords[i].attr('transform', 'translate(-100, 100)');
        }
      });

      // Setup x,y scales
      var bbox = g.node().getBBox();

      x_scale
        .domain([0, 720])
        .range([0, bbox.width]);
      y_scale
        .domain([0, 1390])
        .range([0, bbox.height]);

      d3.csv('battles.csv', function (err, battles) {
        if (err) throw err;

        // Map appropriate data to numbers
        battle_data = battles.map(function (b) {
          b.y_coord       = Number(b.y_coord);
          b.x_coord       = Number(b.x_coord);
          b.location      = b.location.trim();
          return b;
        });

        battle_data.forEach(function (d) {
          // Fill location mapper
          if (d.location) {
            location_mapper[d.location] = {
              x: d.x_coord,
              y: d.y_coord
            }
          }
        });

        d3.csv('route.csv', function (err, routes) {
          if (err) throw err;
          // Map appropriate data to numbers
          route_data = routes.map(function (t) {
            t.start_time        = Number(t.start_time);
            t.end_time          = Number(t.end_time);
            t.army_size_before  = Number(t.army_size_before);
            t.army_size_after   = Number(t.army_size_after);
            t.start_location    = t.start_location.trim();
            t.target_location   = t.target_location.trim();
            t.is_done           = t.is_done === '1' ? true : false;
            return t;
          });

          // Save last time step
          LAST_STEP = d3.max(route_data, function (d) { return d.end_time; });

          // Set up scale
          army_scale
            .domain([0, d3.max(route_data, function (d) {
              return Math.max(d.army_size_before, d.army_size_after);
            })])
            .range([5, 30]);

          // Setup armies for first time step
          var initial = route_data.filter(function (d) {
            return d.start_time == 0;
          });

          initial.forEach(function (d) {
            g.append('circle')
              .style('fill', affiliation_mapper[d.affiliation])
              .style('opacity', hidden_families[d.affiliation.toLowerCase()] ? '0' : army_opacity)
              .attr('class', 'army ' + d.affiliation.toLowerCase())
              .attr('id', single_word(d.party_leader))
              .attr('r', army_scale(d.army_size_before))
              .attr('cx', x_scale(location_mapper[d.start_location].x))
              .attr('cy', y_scale(location_mapper[d.start_location].y));
          });
        });
      });
    });

    /**
     * Goes to current_step in the animation and animates to the following step.
     */
    function do_step () {
      if (current_step == LAST_STEP) return;

      d3.select('#slider-value').text(current_step);
      d3.select('#player #time-select')[0][0].value = current_step;

      // Stop at this step
      if (!IS_PLAYING) {
        d3.selectAll('.army').transition();
        finish_step();
        return;
      }

      // Setup current time step armies
      var starts_now = route_data.filter(function (d) {
        return d.start_time == current_step;
      });
      var moving_now = route_data.filter(function (d) {
        return d.end_time > current_step && d.start_time < current_step;
      });
      var ending_now = route_data.filter(function (d) {
        return d.end_time == current_step;
      });

      starts_now.forEach(function (m) {
        var army = g.select('#' + single_word(m.party_leader));
        if (army.empty()) {
          // Must create army
          g.append('circle')
            .style('fill', affiliation_mapper[m.affiliation])
            .style('opacity', hidden_families[m.affiliation.toLowerCase()] ? '0' : army_opacity)
            .attr('class', 'army ' + m.affiliation.toLowerCase())
            .attr('id', single_word(m.party_leader))
            .attr('r', army_scale(m.army_size_before))
            .attr('cx', x_scale(location_mapper[m.start_location].x))
            .attr('cy', y_scale(location_mapper[m.start_location].y));

        } else {
          // Ensure they've reached starting location
          army
            .attr('r', army_scale(m.army_size_before))
            .attr('cx', x_scale(location_mapper[m.start_location].x))
            .attr('cy', y_scale(location_mapper[m.start_location].y))
        }

        // Animate to ending location
        army
          .transition()
          .ease('linear')
          .attr('r', army_scale(m.army_size_after))
          .attr('cx', x_scale(location_mapper[m.target_location].x))
          .attr('cy', y_scale(location_mapper[m.target_location].y))
          .duration(STEP_DURATION * (m.end_time - m.start_time));

        if (m.is_done) {
          setTimeout(function (elm) {
            elm.transition()
              .attr('r', 0);
          },
          STEP_DURATION * (m.end_time - m.start_time),
          g.select('#' + single_word(m.party_leader)));
        }
      });

      // Armies that are moving now should go from their interpolated location
      moving_now.forEach(function (m) {
        var army = g.select('#' + single_word(m.party_leader));

        // Calculate interpolated location
        var duration = m.end_time - m.start_time,
            frac = (current_step - m.start_time) / duration;

        var s = location_mapper[m.start_location],
            t = location_mapper[m.target_location];

        var inter_x    = (t.x - s.x) * frac + s.x,
            inter_y    = (t.y - s.y) * frac + s.y,
            inter_size = (m.army_size_after - m.army_size_before) * frac + m.army_size_before;

        // Set location
        army
          .attr('r', army_scale(inter_size))
          .attr('cx', x_scale(inter_x))
          .attr('cy', y_scale(inter_y));

        // Animate to ending location
        army
          .transition()
          .ease('linear')
          .attr('r', army_scale(m.army_size_after))
          .attr('cx', x_scale(location_mapper[m.target_location].x))
          .attr('cy', y_scale(location_mapper[m.target_location].y))
          .duration(STEP_DURATION * (m.end_time - current_step));
      });

      // Armies that end now should go to their target location and die if necessary
      ending_now.forEach(function (m) {
        var army = g.select('#' + single_word(m.party_leader));
        if (m.is_done) {
          army.transition().attr('r', 0);
        }
      });

      // Battle icon
      var current_battles = battle_data.filter(function (b) {
        return b.time_data == current_step && b.time_data !== '';
      });

      // Reset swords
      swords.forEach(function (s) {
        s.attr('transform', 'translate(-100, -100)');
      });
      current_battles.forEach(function (b, i) {
        var loc = location_mapper[b.location];
        swords[i]
          .attr('transform', 'translate(' + x_scale(loc.x) + ',' + y_scale(loc.y) + ')scale(0.5)')
          .transition()
          .attr('transform', 'translate(' + x_scale(loc.x) + ',' + y_scale(loc.y) + ')');
      });

      // Schedule next step if not last and if playing
      if (current_step < LAST_STEP)
        next_step = setTimeout(do_step, STEP_DURATION);

      current_step++;
    }

    /**
     * Goes to current_step in the animation
     */
    function goto_step () {
      var current_armies = [];

      // Grab relevant armies
      var starts_now = route_data.filter(function (d) {
        return d.start_time == current_step;
      });
      var moving_now = route_data.filter(function (d) {
        return d.end_time > current_step && d.start_time < current_step;
      });
      var ending_now = route_data.filter(function (d) {
        return d.end_time == current_step;
      });

      //console.log(starts_now, moving_now, ending_now);

      // Armies that start now should just appear and stay at their start location
      starts_now.forEach(function (m) {
        current_armies.push(single_word(m.party_leader));
        var army = g.select('#' + single_word(m.party_leader));
        if (army.empty()) {
          // Must create army
          g.append('circle')
            .style('fill', affiliation_mapper[m.affiliation])
            .style('opacity', hidden_families[m.affiliation.toLowerCase()] ? '0' : army_opacity)
            .attr('class', 'army ' + m.affiliation.toLowerCase())
            .attr('id', single_word(m.party_leader))
            .attr('r', army_scale(m.army_size_before))
            .attr('cx', x_scale(location_mapper[m.start_location].x))
            .attr('cy', y_scale(location_mapper[m.start_location].y));

        } else {
          // Ensure they've reached starting location
          army
            .attr('r', army_scale(m.army_size_before))
            .attr('cx', x_scale(location_mapper[m.start_location].x))
            .attr('cy', y_scale(location_mapper[m.start_location].y))
        }
      });

      // Armies that are moving now should go to their interpolated location
      moving_now.forEach(function (m) {
        current_armies.push(single_word(m.party_leader));

        var army = g.select('#' + single_word(m.party_leader));

        // Calculate interpolated location
        var duration = m.end_time - m.start_time,
            frac = (current_step - m.start_time) / duration;

        var s = location_mapper[m.start_location],
            t = location_mapper[m.target_location];

        var inter_x    = (t.x - s.x) * frac + s.x,
            inter_y    = (t.y - s.y) * frac + s.y,
            inter_size = (m.army_size_after - m.army_size_before) * frac + m.army_size_before;

        if (army.empty()) {
          g.append('circle')
            .style('fill', affiliation_mapper[m.affiliation])
            .style('opacity', hidden_families[m.affiliation.toLowerCase()] ? '0' : army_opacity)
            .attr('class', 'army ' + m.affiliation.toLowerCase())
            .attr('id', single_word(m.party_leader))
            .attr('r', army_scale(m.army_size_before))
            .attr('cx', x_scale(location_mapper[m.start_location].x))
            .attr('cy', y_scale(location_mapper[m.start_location].y));

        } else {
          // Set location
          army
            .attr('r', army_scale(inter_size))
            .attr('cx', x_scale(inter_x))
            .attr('cy', y_scale(inter_y));
        }
      });

      // Armies that end now should go to their target location and die if necessary
      ending_now.forEach(function (m) {
        current_armies.push(single_word(m.party_leader));
        var army = g.select('#' + single_word(m.party_leader));
        // Ensure they've reached ending location
        if (army.empty()) {
          g.append('circle')
            .style('fill', affiliation_mapper[m.affiliation])
            .style('opacity', hidden_families[m.affiliation.toLowerCase()] ? '0' : army_opacity)
            .attr('class', 'army ' + m.affiliation.toLowerCase())
            .attr('id', single_word(m.party_leader))
            .attr('r', army_scale(m.army_size_after))
            .attr('cx', x_scale(location_mapper[m.target_location].x))
            .attr('cy', y_scale(location_mapper[m.target_location].y));

        } else {
          army
            .attr('r', army_scale(m.army_size_after))
            .attr('cx', x_scale(location_mapper[m.target_location].x))
            .attr('cy', y_scale(location_mapper[m.target_location].y));
        }
        if (m.is_done) {
          army.transition()
            .attr('r', 0);
        }
      });

      var current_battles = battle_data.filter(function (b) {
        return b.time_data == current_step && b.time_data !== '';
      });

      // Reset swords
      swords.forEach(function (s) {
        s.transition();
        s.attr('transform', 'translate(-100, -100)');
      });
      current_battles.forEach(function (b, i) {
        var loc = location_mapper[b.location];
        swords[i]
          .attr('transform', 'translate(' + x_scale(loc.x) + ',' + y_scale(loc.y) + ')scale(0.5)')
          .transition()
          .attr('transform', 'translate(' + x_scale(loc.x) + ',' + y_scale(loc.y) + ')');
      });
      // Remove unneeded armies
      d3.selectAll('.army')
        .filter(function () {
          return current_armies.indexOf(this.id) < 0;
        })
        .remove();
    }

    function finish_step () {
      console.log('done lol');
    }

    /**************************************************************************/

    /**
     * Zoom behavior for map
     */
    function zoom_func () {
      var trans = d3.event.translate,
          scale = d3.event.scale;

      // Pan limiting
      if (trans[1] > 1) {
        trans[1] = 0;
      } else if (trans[1] < -height * scale + height - 1) {
        trans[1] = -height * scale + height;
      }

      if (trans[0] > 1) {
        trans[0] = 0;
      } else if (trans[0] < -width * scale + width - 1) {
        trans[0] = -width * scale + width;
      }

      zoom_behavior.translate(trans);
      g.attr('transform', 'translate(' + trans + ')scale(' + scale + ')');
    }

    /**
     * Removes all whitespace from the given string
     */
    function single_word (str) {
      return str.replace(' ', '').trim();
    }

    /**************************************************************************/

    d3.select('#player #play').on('click', function () {
      IS_PLAYING = true;
      do_step();
    });
    d3.select('#player #pause').on('click', function () {
      IS_PLAYING = false;
    });
    d3.select('#player #reset').on('click',function (){
      IS_PLAYING = false;
      current_step = 0;
      goto_step();
    })
    d3.select('#player #time-select').on('input', function () {
      d3.select('#slider-value').text(this.value);
      IS_PLAYING = false;
      current_step = this.value;
      goto_step();
    });

    var timeline= d3.select("#timeline")
                    .append("svg")
                    .attr("width",200)
                    .attr("height",725)
                    .style("border", "none");

    var side = d3.select("#side")
                .append("svg")
                .attr("width", 700)
                .attr("height", 700);
    
    var event_info = {};
    var event_id_mapper = {};

    var affiliation = {
      "Joffery Baratheon": "images/Lannister-Emblem.png",
      "Balon Greyjoy":     "images/Greyjoy-Emblem.png",
      "Robb Stark":        "images/stark-emblem.png",
      "Renly Baratheon":   "images/renly-emblem.png",
      "Stannis Baratheon": "images/stannis-emblem.png"
    }

    var commander = {
      "Asha Greyjoy":      "images/Asha-Greyjoy.png",
      "Balon Greyjoy":     "images/Balon-Greyjoy.png",
      "Beric Dondarrion":  "images/Beric-Dondarrion.png",
      "Bran Stark":        "images/Bran-Stark.png",
      "Brynden Tully":     "images/Bryden-Tully.png",
      "Edmure Tully":      "images/Edmure-Tully.png",
      "Gregor Clegane":    "images/Gregor-Clegane.png",
      "Jaime Lannister":   "images/Jaime-Lannister.png",
      "Joffery Baratheon": "images/Joffery-Baratheon.png",
      "Loras Tyrell":      "images/Loras-Tyrell.png",
      "Mace Tyrell":       "images/Mace-Tyrell.png",
      "Mance Rayder":      "images/Mance-Rayder.png",
      "Ramsey Bolton":     "images/Ramsey-Bolton.png",
      "Renly Baratheon":   "images/Renly-Baratheon.png",
      "Robb Stark":        "images/Robb-Stark.png",
      "Roose Bolton":      "images/Roose-Bolton.png",
      "Stannis Baratheon": "images/Stannis-Baratheon.png",
      "Theon Greyjoy":     "images/Theon-Greyjoy.png",
      "Tyrion Lannister":  "images/Tyrion-Lannister.png",
      "Tywin Lannister":   "images/Tywin-Lannister.png",
      "Walder Frey":       "images/Walder-Frey.png"
    }

    d3.csv('battles.csv', function (err, battles) {
      // list out all events
      // Map appropriate data to numbers
      var event_info = battles.map(function (b) {
        b.battle_number = Number(b.battle_number);
        b.y_coord       = Number(b.y_coord);
        b.x_coord       = Number(b.x_coord);
        b.episode       = Number(b.episode);
        b.location      = b.location.trim();
        b.time_data     = Number(b.time_data);
        return b;
      });

      event_info.forEach(function (d) {
        if (d.battle_number) {
          event_id_mapper[d.battle_number] = d;
        }
      });

      var list_yScale = d3.scale.linear()
        .domain([0, Object.keys(event_id_mapper).length - 1])
        .range([height - 60, 20]);

      var list_events = [];

      // accumulate a list of events
      Object.keys(event_id_mapper).forEach(function (id,i){
          list_events.push(event_id_mapper[id]);
      });

      Object.keys(event_id_mapper).reverse().forEach(function (id,i){
        timeline.append("text")
        .attr("x", 12)
        .attr("y", list_yScale(i))
        .text(event_id_mapper[id].name)
        .style("font-size", 14)
        .style("fill","black");

        // this is the sword of steel
        // timeline.append('image')
        //           .attr('xlink:href','http://www.clker.com/cliparts/2/b/2/8/13663778451350263915sword.svg')
        //           .attr('class', 'pico')
        //           .attr('height', 30)
        //           .attr('width', 20)
        //           .attr('x', 0)
        //           .attr('y', 3+i*18);
      });

      var iter = 0;
      timeline.selectAll("rect")
        .data(list_events).enter()
        .append("rect")
        .attr("x", 8)
        .attr("y", function (d) {
          var scaledY = list_yScale(list_events.length - iter - 1) - 15;
          iter++;
          return scaledY;
        })
        .attr("height", 18)
        .attr("width", 165)
        .style("stroke", "none")
        .style("fill", "transparent");

        // loop thorugh events to display them
        
    function addText (text, x, y, size) {
      side.append("text")
        .text(text)
        .attr("x", x)
        .attr("y", y)
        .style("text-anchor","middle")
        .style("font-size", size)
        .style("fill", "black");
    }

    function addImage(x, y, height, width, url){
      side.append('image')
        .attr('xlink:href',url)
        .attr('class', 'pico')
        .attr('height', height)
        .attr('width', width)
        .attr('x', x)
        .attr('y', y);
    }

    d3.select("#timeline").selectAll("rect").on("click", function(d, i) {
      // remove all text and replace
      d3.select("#side").selectAll("text").remove();
          
      d3.select("#timeline").selectAll("rect").style("fill", "transparent");

      d3.select(this).style("fill", "red").style("opacity", 0.3);

      IS_PLAYING = false;
      current_step = d.time_data;
      d3.select('#slider-value').text(d.time_data);
      d3.select('#player #time-select')[0][0].value = d.time_data;
      goto_step();



      d3.select("#side").selectAll("text").remove();
      d3.select("#side").selectAll("image").remove();

      console.log(d);
      var defender_outcome="";
      if(d.attacker_outcome=="win"){
            defender_outcome= "loss";
      }
      else{
            defender_outcome="win";
      }
      addText(d.name, 250,30,36);
      addText(d.location + ", " + d.year, 250,60,20);
      addText("Attacker", 100, 90,20);
      addText("Defender", 400, 90,20);
      addText("Affiliation",250, 450, 20);
      addText(d.attacker_king, 100, 450, 16);
      addText(d.defender_king, 400, 450, 16);
      addText("Commander Name",250, 500, 20);
      addText(d.attack_commander, 100, 500, 16);
      addText(d.defender_commander, 400, 500, 16);
      addText("Army Size", 250, 550, 20);
      addText(d.attacker_size, 100, 550, 16);
      addText(d.defender_size, 400, 550, 16);
      addText("Outcome", 250, 600, 20);
      addText(d.attacker_outcome, 100, 600, 50);
      addText(defender_outcome, 400, 600, 50);

      addImage(200, 150, 100, 100, "http://www.clker.com/cliparts/7/l/N/9/Q/C/black-crossed-swords-hi.png");//crossed sword
      addImage(60, 320, 75, 75, affiliation[d.attacker_king]);//attacker banner
      addImage(360, 320, 75, 75, affiliation[d.defender_king]);//defender banner
      addImage(0, 100, 200, 200, commander[d.main_attacker]);//attacker king
      addImage(300, 100, 200, 200, commander[d.main_defender]);//defender king

      side.append('image')
        .attr('xlink:href',"http://www.imarvintpa.com/Mapping/Overlays/Blood/Blood%20splatter%2019-sc.png")
        .attr('class', 'pico')
        .attr('height', 600)
        .attr('width', 700)
        .attr('x', 0)
        .attr('y', 120)
        .attr("opacity", 0.200);
      });

  // Before clicking on a battle the initial battle screen
    // crossed swords
    addImage(200, 150, 100, 100, "http://www.clker.com/cliparts/7/l/N/9/Q/C/black-crossed-swords-hi.png")
    // blood overlay
    side.append('image')
        .attr('xlink:href',"http://www.imarvintpa.com/Mapping/Overlays/Blood/Blood%20splatter%2019-sc.png")
        .attr('class', 'pico')
        .attr('height', 700)
        .attr('width', 700)
        .attr('x', 0)
        .attr('y', 120)
        .attr("opacity", 0.200);

    // prompt to select a
    addText("Instructions",250,30,36);
    addText("1. Click a battle to view it's location on map and the battle stats",250,50,16);
    addText("2. Press play and pause to view the overall War progression",250,70,16);
    addText("3. Select banners along the top to view specific family battles",250,90,16);
      
  });
  </script>
</body>
</html>
